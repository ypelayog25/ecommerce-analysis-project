name: Update Dashboard

on:
  workflow_dispatch:  # âœ… Manual trigger
  schedule:
    - cron: "0 3 * * *"  # âœ… Runs daily at 03:00 UTC, does NOT conflict with update_dataset.yml

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
      # âœ… Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      # âœ… Setup Python environment
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # âœ… Install dependencies (use same libs as analysis pipeline)
      - name: Install dependencies
        run: |
          pip install pandas numpy matplotlib pyarrow duckdb streamlit

      # âœ… Detect if dataset changed by hash comparison
      - name: Check dataset hash
        id: dashboard-hash
        run: |
          FILE="data/processed/ecommerce_dataset_10000_cleaned.parquet"
          HASH_FILE="data/processed/.dashboard_hash.txt"

          if [ ! -f "$FILE" ]; then
            echo "âŒ Dataset file not found: $FILE"
            exit 1
          fi

          NEW_HASH=$(sha256sum $FILE | cut -d " " -f1)
          echo "ðŸ” NEW_HASH=$NEW_HASH"

          if [ -f "$HASH_FILE" ]; then
            OLD_HASH=$(cat $HASH_FILE)
          else
            OLD_HASH=""
          fi

          echo "â„¹ï¸ OLD_HASH=$OLD_HASH"

          if [[ "$NEW_HASH" != "$OLD_HASH" ]]; then
            echo "âœ… Dataset change detected, dashboard will be updated."
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No dataset changes. Skipping dashboard update."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # âœ… Run feature engineering
      - name: Run feature engineering
        if: steps.dashboard-hash.outputs.changed == 'true'
        run: |
          echo "ðŸš€ Running feature engineering..."
          python src/features/create_features.py

      # âœ… Run optional customer segmentation model if script exists
      - name: Run customer segmentation (optional)
        if: steps.dashboard-hash.outputs.changed == 'true' && hashFiles('src/models/customer_segmentation.py') != ''
        run: |
          echo "ðŸ§  Running optional customer segmentation model..."
          python src/models/customer_segmentation.py || echo "âš ï¸ Skipped - models script optional"

      # âœ… Generate dashboard visuals
      - name: Generate dashboard visuals
        if: steps.dashboard-hash.outputs.changed == 'true'
        run: |
          echo "ðŸ“Š Generating dashboard PNG exports..."
          python src/visualization/generate_dashboard.py

      # âœ… Save new hash
      - name: Save new dashboard hash
        if: steps.dashboard-hash.outputs.changed == 'true'
        run: |
          FILE="data/processed/ecommerce_dataset_10000_cleaned.parquet"
          NEW_HASH=$(sha256sum $FILE | cut -d " " -f1)
          echo "$NEW_HASH" > data/processed/.dashboard_hash.txt
          echo "âœ… Hash updated"

      # âœ… Upload visual assets (PNG charts) for preview/download
      - name: Upload dashboard artifacts
        if: steps.dashboard-hash.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-figures
          path: reports/figures/*.png
