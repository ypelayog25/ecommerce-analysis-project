name: Update Dashboard

on:
  workflow_dispatch:
    # Manual trigger
  schedule:
    - cron: "0 3 * * *"  # Runs daily at 03:00 UTC

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      # 2️⃣ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          pip install pandas numpy matplotlib pyarrow duckdb streamlit plotly kaleido

      # 4️⃣ Detect dataset changes via hash
      - name: Check dataset hash
        id: dashboard-hash
        run: |
          FILE="data/processed/ecommerce_dataset_10000_cleaned.parquet"
          HASH_FILE="data/processed/.dashboard_hash.txt"

          if [ ! -f "$FILE" ]; then
            echo "❌ Dataset file not found: $FILE"
            exit 1
          fi

          NEW_HASH=$(sha256sum "$FILE" | cut -d " " -f1)
          OLD_HASH=""
          if [ -f "$HASH_FILE" ]; then
            OLD_HASH=$(cat "$HASH_FILE")
          fi

          echo "🔍 NEW_HASH=$NEW_HASH"
          echo "ℹ️ OLD_HASH=$OLD_HASH"

          if [[ "$NEW_HASH" != "$OLD_HASH" ]]; then
            echo "✅ Dataset change detected. Dashboard will be updated."
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️ No dataset changes. Skipping dashboard update."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # 5️⃣ Run feature engineering if dataset changed
      - name: Run feature engineering
        if: steps.dashboard-hash.outputs.changed == 'true'
        run: |
          echo "🚀 Running feature engineering..."
          python src/features/create_features.py

      # 6️⃣ Run optional customer segmentation
      - name: Run customer segmentation (optional)
        if: steps.dashboard-hash.outputs.changed == 'true' && hashFiles('src/models/customer_segmentation.py') != ''
        run: |
          echo "🧠 Running optional customer segmentation model..."
          python src/models/customer_segmentation.py || echo "⚠️ Skipped - models script optional"

      # 7️⃣ Ensure figures folder exists
      - name: Ensure figures folder exists
        if: steps.dashboard-hash.outputs.changed == 'true'
        run: mkdir -p reports/figures

      # 8️⃣ Generate dashboard visuals
      - name: Generate dashboard visuals
        if: steps.dashboard-hash.outputs.changed == 'true'
        run: |
          echo "📊 Generating dashboard PNG exports..."
          python scripts/generate_dashboard.py

      # 9️⃣ Save new dataset hash
      - name: Save new dashboard hash
        if: steps.dashboard-hash.outputs.changed == 'true'
        run: |
          FILE="data/processed/ecommerce_dataset_10000_cleaned.parquet"
          NEW_HASH=$(sha256sum "$FILE" | cut -d " " -f1)
          echo "$NEW_HASH" > data/processed/.dashboard_hash.txt
          echo "✅ Hash updated"

      # 🔟 Upload visual artifacts
      - name: Upload dashboard artifacts
        if: steps.dashboard-hash.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-figures
          path: reports/figures/*.png
