name: 🔧 Feature Engineering & Export

on:
  push:
    paths:
      - "data/raw/**"
      - "src/features/**"
      - "src/data/**"
  workflow_dispatch:

jobs:
  feature-engineering:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout repository
        uses: actions/checkout@v3

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 📦 Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt || echo "⚠ requirements.txt no encontrado, instalando mínimos..."
          pip install pandas pyarrow

      - name: 📁 Ensure Python package structure (auto __init__.py)
        run: |
          echo "📂 Ensuring Python package structure..."
          python - << 'EOF'
import os
PACKAGE_DIRS = [
    "src",
    "src/data",
    "src/features",
    "src/models",
    "src/visualization"
]
for directory in PACKAGE_DIRS:
    os.makedirs(directory, exist_ok=True)
    init_path = os.path.join(directory, "__init__.py")
    if not os.path.exists(init_path):
        with open(init_path, "w") as f:
            f.write("# Auto-generated")
        print(f"✅ Created: {init_path}")
    else:
        print(f"✔ Exists: {init_path}")
EOF

      - name: 🚀 Run Feature Engineering (no metadata check required)
        run: |
          echo "🔧 Running feature engineering..."
          python src/features/create_features.py || echo "⚠ Script returned a warning, but continuing..."

      - name: 📤 Upload processed dataset as artifact
        uses: actions/upload-artifact@v3
        with:
          name: processed-dataset
          path: |
            data/processed/*.csv
            data/processed/*.parquet
