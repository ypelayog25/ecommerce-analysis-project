name: Feature Engineering & Streamlit Deployment

on:
  workflow_dispatch:    # Manual trigger
  push:
    branches:
      - main
    paths:
      - "src/features/**"
      - "data/raw/**"

jobs:
  feature-streamlit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install streamlit plotly pandas pyarrow

      - name: Run Feature Engineering (non-blocking)
        run: |
          python src/features/create_features.py || echo "⚠ Feature engineering skipped or failed"

      - name: Verify Columns (non-blocking)
        run: |
          python scripts/verify_columns.py || echo "⚠ Warning: some columns may be missing"

      - name: Commit processed dataset (if changes)
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/processed/
          if ! git diff --staged --quiet; then
            git commit -m "feat: update processed dataset via workflow"
            git push origin main
          else
            echo "ℹ️ No changes to processed dataset"

      - name: Optional: Trigger Streamlit cloud deploy
        run: |
          echo "✅ Dataset updated. Streamlit Cloud will auto-update from main branch."
