name: Update Dataset and Run Analysis

on:
  workflow_dispatch: # Permite ejecuciÃ³n manual
  schedule:
    - cron: "0 3 * * *" # Todos los dÃ­as a las 3 AM UTC

jobs:
  update-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure Kaggle API
        run: |
          mkdir -p ~/.kaggle
          echo "${{ secrets.KAGGLE_JSON }}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      # ðŸ” DEBUG â€” SOLO PARA PRUEBA (BORRAR DESPUÃ‰S)
      - name: Debug Kaggle Secret (TEMPORAL - ELIMINAR DESPUÃ‰S)
        run: |
          echo "Contenido real de ~/.kaggle/kaggle.json:"
          cat ~/.kaggle/kaggle.json

      - name: Test Kaggle Authentication
        run: kaggle datasets list -s ecommerce

      - name: Create data/raw directory if missing
        run: mkdir -p data/raw

      - name: Check for dataset update
        id: check
        run: |
          LATEST_HASH=$(kaggle datasets metadata nabihazahid/ecommerce-dataset-for-sql-analysis | md5sum | awk '{print $1}')
          echo "Latest hash: $LATEST_HASH"

          if [ -f data/raw/.dataset_hash.txt ]; then
            OLD_HASH=$(cat data/raw/.dataset_hash.txt)
          else
            OLD_HASH=""
          fi

          echo "Old hash: $OLD_HASH"

          if [ "$LATEST_HASH" != "$OLD_HASH" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo $LATEST_HASH > data/raw/.dataset_hash.txt
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Download dataset from Kaggle (only if updated)
        if: steps.check.outputs.update_needed == 'true'
        run: kaggle datasets download -d nabihazahid/ecommerce-dataset-for-sql-analysis -p data/raw --unzip

      - name: Run analysis script
        if: steps.check.outputs.update_needed == 'true'
        run: python3 src/analysis_pipeline.py

      - name: Commit and push changes
        if: steps.check.outputs.update_needed == 'true'
        run: |
          git config user.name "Yenismara Pelayo Garcia"
          git config user.email "ypelayog25@gmail.com"
          git add .
          git commit -m "feat: automated update and analysis from Kaggle dataset"
          git push
